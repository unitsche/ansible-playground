---
- name: deploy percona cluster
  hosts: pxc
  vars:
    db_name: ekrprod
    db_user: ekruser
  vars_files:
    - mysqlsecrets.yml
    - masterdb.yml
    - slave.yml

  tasks:

  - name: Update apt cache
    sudo: yes
    apt: update_cache=yes

  - name: Install basic python packages
    apt: pkg={{ item }} state=present
    sudo: True
    with_items:
     - vim
     - python-pycurl
     - python-mysqldb

  - name: add percona repository key id
    apt_key: keyserver=keys.gnupg.net id=1C4CBDCDCD2EFD2A state=present
    sudo: True

  - name: add percona repository to sourcelist
    apt_repository: repo='deb http://repo.percona.com/apt trusty main' state=present
    sudo: True

  - name: add percona source repository
    apt_repository: repo='deb-src http://repo.percona.com/apt trusty main' state=present
    sudo: True

  - name: install the percona apt packages on the host
    apt: pkg={{ item }} state=present update_cache=yes
    sudo: True
    with_items:
      - percona-server-common-5.6
      - percona-server-client-5.6
      - percona-server-server-5.6
    environment:
      DEBIAN_FRONTEND: noninteractive

  - name: Create percona configuration file
    sudo: True
    template: src=../templates/my.cnf.j2 dest=/etc/mysql/my.cnf
    notify:
    - restart mysql

  - name: Create database
    sudo: True
    mysql_db: name={{ db_name }} state=present
    notify:
      - restart mysql

  - name: Create a the app database user
    mysql_user: name={{ db_user }} password={{ percona_user_passwd }} priv={{ db_name }}.*:ALL state=present
 
  - name: Update percona root password for all root accounts
    sudo: True
    mysql_user: name=root host={{ item }} password={{ percona_root_passwd }}
    with_items:
      - "{{ ansible_hostname }}"
      - 127.0.0.1
      - ::1
      - "{{ db_name }}"
      - 10.11.12.13
      - localhost

  - name: db grant 
    sudo: True
    command: >
       /usr/bin/mysql -uroot -p"{{ percona_root_passwd }}"
        -e "GRANT ALL PRIVILEGES ON {{ db_name }}.* TO '{{ db_user }}'@'10.11.12.13' IDENTIFIED BY '{{ percona_user_passwd }}'"
    tags:
      - debug

  - name: flush privileges
    command: >
        /usr/bin/mysql -uroot -p"{{ percona_root_passwd }}"
        -e "FLUSH PRIVILEGES;"
    tags:
     - test

  handlers:
  - name: restart mysql
    sudo: True
    service: name=mysql state=restarted
